package fr.ece.controller;

import fr.ece.dao.TaskDAO;
import fr.ece.dao.UserDAO;
import fr.ece.model.User;
import fr.ece.util.PasswordUtils;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.input.KeyEvent;
import javafx.scene.text.Text;
import javafx.stage.Stage;

import java.io.IOException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Optional;

public class UserManagementController {

    // ===== √âL√âMENTS FXML =====
    @FXML private TableView<User> usersTable;
    @FXML private TableColumn<User, Integer> idColumn;
    @FXML private TableColumn<User, String> usernameColumn;
    @FXML private TableColumn<User, String> roleColumn;
    @FXML private TableColumn<User, LocalDateTime> createdAtColumn;
    @FXML private TableColumn<User, Integer> tasksCountColumn;
    @FXML private TableColumn<User, Void> actionsColumn;

    @FXML private TextField searchField;
    @FXML private ComboBox<String> filterComboBox;

    @FXML private Button changeRoleButton;
    @FXML private Button resetPasswordButton;
    @FXML private Button deleteButton;

    @FXML private Label statusLabel;
    @FXML private Label countLabel;
    @FXML private Label currentUserLabel;

    @FXML private Text totalUsersLabel;
    @FXML private Text adminUsersLabel;
    @FXML private Text regularUsersLabel;
    @FXML private Text activeUsersLabel;

    // ===== VARIABLES =====
    private UserDAO userDAO;
    private TaskDAO taskDAO;
    private ObservableList<User> allUsers;
    private User currentUser;

    // ===== INITIALIZE =====
    @FXML
    public void initialize() {
        userDAO = new UserDAO();
        taskDAO = new TaskDAO();

        // Configurer les colonnes
        setupTableColumns();

        // Configurer le filtre
        setupFilter();

        // Charger les utilisateurs
        loadUsers();

        // G√©rer la s√©lection
        usersTable.getSelectionModel().selectedItemProperty().addListener(
                (obs, oldSelection, newSelection) -> {
                    boolean isSelected = (newSelection != null);
                    changeRoleButton.setDisable(!isSelected);
                    resetPasswordButton.setDisable(!isSelected);
                    deleteButton.setDisable(!isSelected || isCurrentUser(newSelection));
                }
        );

        updateStatistics();
    }

    // ===== SETTER =====
    public void setCurrentUser(User user) {
        this.currentUser = user;
        currentUserLabel.setText("Connect√©: " + user.getUsername() + " (ADMIN)");
    }

    // ===== CONFIGURATION =====

    private void setupTableColumns() {
        idColumn.setCellValueFactory(new PropertyValueFactory<>("id"));
        usernameColumn.setCellValueFactory(new PropertyValueFactory<>("username"));
        roleColumn.setCellValueFactory(new PropertyValueFactory<>("role"));
        createdAtColumn.setCellValueFactory(new PropertyValueFactory<>("createdAt"));

        // Formater la date
        createdAtColumn.setCellFactory(column -> new TableCell<User, LocalDateTime>() {
            private DateTimeFormatter formatter = DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm");

            @Override
            protected void updateItem(LocalDateTime date, boolean empty) {
                super.updateItem(date, empty);
                if (empty || date == null) {
                    setText(null);
                } else {
                    setText(formatter.format(date));
                }
            }
        });

        // Colorer la colonne r√¥le
        roleColumn.setCellFactory(column -> new TableCell<User, String>() {
            @Override
            protected void updateItem(String role, boolean empty) {
                super.updateItem(role, empty);
                if (empty || role == null) {
                    setText(null);
                    setStyle("");
                } else {
                    setText(role);
                    if (role.equals("ADMIN")) {
                        setStyle("-fx-background-color: #fff3cd; -fx-text-fill: #f39c12; -fx-font-weight: bold;");
                    } else {
                        setStyle("-fx-background-color: #e3f2fd; -fx-text-fill: #2196F3;");
                    }
                }
            }
        });

        // Compter les t√¢ches de chaque utilisateur
        tasksCountColumn.setCellValueFactory(cellData -> {
            int userId = cellData.getValue().getId();
            int taskCount = taskDAO.countByUser(userId);
            return new javafx.beans.property.SimpleObjectProperty<>(taskCount);
        });

        // Colonne d'actions
        setupActionsColumn();
    }

    private void setupActionsColumn() {
        actionsColumn.setCellFactory(param -> new TableCell<>() {
            private final Button viewBtn = new Button("üëÅÔ∏è Voir");
            private final Button editBtn = new Button("‚úèÔ∏è Modifier");
            private final Button deleteBtn = new Button("üóëÔ∏è");

            {
                viewBtn.getStyleClass().add("secondary-button");
                editBtn.getStyleClass().add("secondary-button");
                deleteBtn.getStyleClass().add("danger-button");

                viewBtn.setOnAction(event -> {
                    User user = getTableView().getItems().get(getIndex());
                    handleViewUser(user);
                });

                editBtn.setOnAction(event -> {
                    User user = getTableView().getItems().get(getIndex());
                    handleEditUser(user);
                });

                deleteBtn.setOnAction(event -> {
                    User user = getTableView().getItems().get(getIndex());
                    if (!isCurrentUser(user)) {
                        handleDeleteUserDirect(user);
                    }
                });
            }

            @Override
            protected void updateItem(Void item, boolean empty) {
                super.updateItem(item, empty);
                if (empty) {
                    setGraphic(null);
                } else {
                    User user = getTableView().getItems().get(getIndex());

                    // D√©sactiver le bouton supprimer pour l'utilisateur actuel
                    deleteBtn.setDisable(isCurrentUser(user));

                    javafx.scene.layout.HBox buttons = new javafx.scene.layout.HBox(5);
                    buttons.getChildren().addAll(viewBtn, editBtn, deleteBtn);
                    setGraphic(buttons);
                }
            }
        });
    }

    private void setupFilter() {
        filterComboBox.setItems(FXCollections.observableArrayList(
                "Tous",
                "Administrateurs",
                "Utilisateurs",
                "Avec t√¢ches",
                "Sans t√¢ches"
        ));
        filterComboBox.setValue("Tous");
    }

    // ===== CHARGEMENT DES DONN√âES =====

    private void loadUsers() {
        try {
            List<User> users = userDAO.findAll();
            allUsers = FXCollections.observableArrayList(users);
            usersTable.setItems(allUsers);
            updateCount();
            statusLabel.setText("Utilisateurs charg√©s");
        } catch (Exception e) {
            statusLabel.setText("Erreur lors du chargement");
            showAlert("Erreur", "Impossible de charger les utilisateurs: " + e.getMessage());
        }
    }

    private void updateStatistics() {
        try {
            int total = allUsers.size();
            totalUsersLabel.setText(String.valueOf(total));

            long admins = allUsers.stream().filter(u -> u.getRole().equals("ADMIN")).count();
            adminUsersLabel.setText(String.valueOf(admins));

            long regular = allUsers.stream().filter(u -> u.getRole().equals("USER")).count();
            regularUsersLabel.setText(String.valueOf(regular));

            // Pour "actifs aujourd'hui", vous pouvez impl√©menter une logique de derni√®re connexion
            // Pour l'instant, on met 0 ou un nombre fictif
            activeUsersLabel.setText("0");

        } catch (Exception e) {
            System.err.println("Erreur mise √† jour statistiques: " + e.getMessage());
        }
    }

    // ===== HANDLERS =====

    @FXML
    private void handleBack(ActionEvent event) {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/fxml/dashboard.fxml"));
            Scene scene = new Scene(loader.load());

            DashboardController controller = loader.getController();
            controller.setCurrentUser(currentUser);

            Stage stage = (Stage) usersTable.getScene().getWindow();
            stage.setScene(scene);
            stage.setTitle("Task Manager - Dashboard");

        } catch (IOException e) {
            showAlert("Erreur", "Impossible de retourner au dashboard");
        }
    }

    @FXML
    private void handleSearch(KeyEvent event) {
        String searchTerm = searchField.getText().toLowerCase().trim();

        if (searchTerm.isEmpty()) {
            usersTable.setItems(allUsers);
        } else {
            ObservableList<User> filtered = allUsers.filtered(user ->
                    user.getUsername().toLowerCase().contains(searchTerm)
            );
            usersTable.setItems(filtered);
        }
        updateCount();
    }

    @FXML
    private void handleFilterChange(ActionEvent event) {
        String filter = filterComboBox.getValue();

        if (filter == null || filter.equals("Tous")) {
            usersTable.setItems(allUsers);
            updateCount();
            return;
        }

        ObservableList<User> filtered = allUsers.filtered(user -> {
            switch (filter) {
                case "Administrateurs":
                    return user.getRole().equals("ADMIN");
                case "Utilisateurs":
                    return user.getRole().equals("USER");
                case "Avec t√¢ches":
                    return taskDAO.countByUser(user.getId()) > 0;
                case "Sans t√¢ches":
                    return taskDAO.countByUser(user.getId()) == 0;
                default:
                    return true;
            }
        });

        usersTable.setItems(filtered);
        updateCount();
        statusLabel.setText("Filtre appliqu√©: " + filter);
    }

    @FXML
    private void handleAddUser(ActionEvent event) {
        // Ouvrir la vue d'inscription
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/fxml/register.fxml"));
            Scene scene = new Scene(loader.load());

            Stage registerStage = new Stage();
            registerStage.setTitle("Nouvel Utilisateur");
            registerStage.setScene(scene);
            registerStage.showAndWait();

            // Rafra√Æchir apr√®s fermeture
            loadUsers();
            updateStatistics();

        } catch (IOException e) {
            showAlert("Erreur", "Impossible d'ouvrir le formulaire");
        }
    }

    @FXML
    private void handleChangeRole(ActionEvent event) {
        User selected = usersTable.getSelectionModel().getSelectedItem();
        if (selected == null) return;

        // Dialogue pour changer le r√¥le
        ChoiceDialog<String> dialog = new ChoiceDialog<>(
                selected.getRole(),
                "ADMIN", "USER"
        );
        dialog.setTitle("Changer le r√¥le");
        dialog.setHeaderText("Modifier le r√¥le de " + selected.getUsername());
        dialog.setContentText("Nouveau r√¥le:");

        Optional<String> result = dialog.showAndWait();
        result.ifPresent(newRole -> {
            if (!newRole.equals(selected.getRole())) {
                selected.setRole(newRole);
                boolean success = userDAO.update(selected);

                if (success) {
                    usersTable.refresh();
                    updateStatistics();
                    statusLabel.setText("R√¥le modifi√©: " + selected.getUsername() + " ‚Üí " + newRole);
                } else {
                    showAlert("Erreur", "Impossible de modifier le r√¥le");
                }
            }
        });
    }

    @FXML
    private void handleResetPassword(ActionEvent event) {
        User selected = usersTable.getSelectionModel().getSelectedItem();
        if (selected == null) return;

        // Dialogue pour nouveau mot de passe
        TextInputDialog dialog = new TextInputDialog();
        dialog.setTitle("R√©initialiser le mot de passe");
        dialog.setHeaderText("Nouveau mot de passe pour " + selected.getUsername());
        dialog.setContentText("Nouveau mot de passe:");

        Optional<String> result = dialog.showAndWait();
        result.ifPresent(newPassword -> {
            if (newPassword.length() < 8) {
                showAlert("Erreur", "Le mot de passe doit contenir au moins 8 caract√®res");
                return;
            }

            String hashedPassword = PasswordUtils.hashPassword(newPassword);
            selected.setPassword(hashedPassword);

            boolean success = userDAO.update(selected);
            if (success) {
                showAlert("Succ√®s", "Mot de passe r√©initialis√© pour " + selected.getUsername());
                statusLabel.setText("Mot de passe r√©initialis√©");
            } else {
                showAlert("Erreur", "Impossible de r√©initialiser le mot de passe");
            }
        });
    }

    @FXML
    private void handleDeleteUser(ActionEvent event) {
        User selected = usersTable.getSelectionModel().getSelectedItem();
        if (selected != null && !isCurrentUser(selected)) {
            handleDeleteUserDirect(selected);
        }
    }

    private void handleDeleteUserDirect(User user) {
        if (isCurrentUser(user)) {
            showAlert("Erreur", "Vous ne pouvez pas supprimer votre propre compte");
            return;
        }

        int taskCount = taskDAO.countByUser(user.getId());

        Alert confirm = new Alert(Alert.AlertType.CONFIRMATION);
        confirm.setTitle("Confirmation");
        confirm.setHeaderText("Supprimer l'utilisateur " + user.getUsername() + " ?");
        confirm.setContentText(
                "Cet utilisateur a " + taskCount + " t√¢che(s).\n" +
                        "Toutes ses t√¢ches seront √©galement supprim√©es.\n\n" +
                        "Cette action est irr√©versible."
        );

        Optional<ButtonType> result = confirm.showAndWait();
        if (result.isPresent() && result.get() == ButtonType.OK) {
            try {
                boolean success = userDAO.delete(user.getId());
                if (success) {
                    allUsers.remove(user);
                    updateStatistics();
                    updateCount();
                    statusLabel.setText("Utilisateur supprim√©: " + user.getUsername());
                } else {
                    showAlert("Erreur", "Impossible de supprimer l'utilisateur");
                }
            } catch (Exception e) {
                showAlert("Erreur", "Erreur: " + e.getMessage());
            }
        }
    }

    private void handleViewUser(User user) {
        int taskCount = taskDAO.countByUser(user.getId());

        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle("D√©tails de l'utilisateur");
        alert.setHeaderText(user.getUsername());
        alert.setContentText(
                "ID: " + user.getId() + "\n" +
                        "R√¥le: " + user.getRole() + "\n" +
                        "Nombre de t√¢ches: " + taskCount + "\n" +
                        "Date de cr√©ation: " + user.getCreatedAt()
        );
        alert.showAndWait();
    }

    private void handleEditUser(User user) {
        // Pour simplifier, on utilise le changement de r√¥le
        // Vous pouvez cr√©er une vue d√©di√©e si n√©cessaire
        handleChangeRole(null);
    }

    // ===== M√âTHODES UTILITAIRES =====

    private boolean isCurrentUser(User user) {
        return currentUser != null && user != null &&
                currentUser.getId() == user.getId();
    }

    private void updateCount() {
        int count = usersTable.getItems().size();
        countLabel.setText(count + (count > 1 ? " utilisateurs" : " utilisateur"));
    }

    private void showAlert(String title, String message) {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle(title);
        alert.setHeaderText(null);
        alert.setContentText(message);
        alert.showAndWait();
    }
}
